<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="http://mrrobot97.github.io/stylesheets/stylesheet.css">
  <link rel="canonical" href="http://mrrobot97.github.io/Loading-Bitmap-Efficiently/">
  <link rel="alternate" type="application/rss+xml" title="Mrrobot" href="http://mrrobot97.github.io/feed.xml">
  <meta name="description" content="Android系统为每个程序都分配了一定的内存，当我们的程序加载比较大的bitmap时十分容易出现OOM(Out Of Memory)的错误，这种错尤其容易出现在用Listiew加载图片时。本篇文章讲述如何高效地加载一个Bitmap，即使其占用的内存足够小.">

   <title>Loading Bitmap Efficiently</title>



</head>


  <body>

    <header class="page-header">
     <h1 class="project-name"> <a class="header-link" href="/"> Mrrobot</a></h1>
     <!--<h3 style="font-weight: lighter;">a blog for <a class="header-link" href="http://canijustgo.com/" target="_blank">canijustgo.com</a></h3>-->
     <h3><a class="header-link" href="https://twitter.com/Mr_Robot___" target="_blank">follow @mrrobot</a></h3>
</header>


    <section class="main-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="main-content" itemprop="articleBody">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Loading Bitmap Efficiently</h1>
   <p class="post-meta"><time datetime="2016-03-20T00:00:00+08:00" itemprop="datePublished">Mar 20, 2016</time></p>
  </header>

    <h4 id="androidbitmapoomout-of-memorylistiewbitmap">Android系统为每个程序都分配了一定的内存，当我们的程序加载比较大的bitmap时十分容易出现OOM(Out Of Memory)的错误，这种错尤其容易出现在用Listiew加载图片时。本篇文章讲述如何高效地加载一个Bitmap，即使其占用的内存足够小.</h4>

<p>文章分析及实例代码来源于Google官方给的Training <a href="http://developer.android.com/training/building-graphics.html">Displaying Bitmaps Efficiently</a></p>

<p>首先我们获取要加载的图片的宽与高与图片类型，方法如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>BitmapFactory.Options options = new BitmapFactory.Options();
options.inJustDecodeBounds = true;
BitmapFactory.decodeResource(getResources(), R.id.myimage, options);
int imageHeight = options.outHeight;
int imageWidth = options.outWidth;
String imageType = options.outMimeType;

</code></pre>
</div>

<p>然后通过比较图片实际的宽高与我们需要在屏幕上显示的大小，调整BitmapFactory.Options的inSampleSize,注意通过设置options.inJustDecodeBounds=true，我们可以只加载图片的大小和类型，而不会真正地将图片加载到内存中。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static int calculateInSampleSize(
            BitmapFactory.Options options, int reqWidth, int reqHeight) {
    // Raw height and width of image
    final int height = options.outHeight;
    final int width = options.outWidth;
    int inSampleSize = 1;

    if (height &gt; reqHeight || width &gt; reqWidth) {

        final int halfHeight = height / 2;
        final int halfWidth = width / 2;

        // Calculate the largest inSampleSize value that is a power of 2 and keeps both
        // height and width larger than the requested height and width.
        while ((halfHeight / inSampleSize) &gt; reqHeight
                &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) {
            inSampleSize *= 2;
        }
    }

    return inSampleSize;
}
</code></pre>
</div>

<p>options.inSampleSize是用来调整图片的压缩比例的，比如inSampleSize=2，就将图片的width和height分别设置为原图片的一半，这样压缩后的图片的体积就只有原来的1/4了。</p>

<p>最后当我们获取到合适的inSampleSize后再将options.inJustDecodeBounds设置为true，就可以真正地将压缩后的图片加载到内存中去了。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static Bitmap decodeSampledBitmapFromResource(Resources res, int resId,
        int reqWidth, int reqHeight) {

    // First decode with inJustDecodeBounds=true to check dimensions
    final BitmapFactory.Options options = new BitmapFactory.Options();
    options.inJustDecodeBounds = true;
    BitmapFactory.decodeResource(res, resId, options);

    // Calculate inSampleSize
    options.inSampleSize = calculateInSampleSize(options, reqWidth, reqHeight);

    // Decode bitmap with inSampleSize set
    options.inJustDecodeBounds = false;
    return BitmapFactory.decodeResource(res, resId, options);
}
</code></pre>
</div>

  </div>

<a href="http://mrrobot97.github.io"><h3 style="text-align: center;">- to blog -</h3></a>

</article>

<div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//mrrobot.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      </div>
    </div>


  </body>

    


</html>
